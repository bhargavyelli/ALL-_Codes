#include "FreeRTOS.h"
#include "task.h"
#include "semphr.h"
#include "stm32l476xx.h"
#include <stdio.h>

void UART2_Init(void);
void UART_SendString(char *str);
void WorkerTask(void *pvParameters);

SemaphoreHandle_t countingSem;
int taskNumbers[5];

int main(void)
{
    UART2_Init();



    // Create counting semaphore
    // Max count = 3
    // Initial count = 3
    countingSem = xSemaphoreCreateCounting(3, 3);

    // Create 5 tasks
    for(int i = 0; i < 5; i++)
    {
    	 taskNumbers[i] = i;
        xTaskCreate(WorkerTask, "Worker", 256, &taskNumbers[i], 1, NULL);
    }

    vTaskStartScheduler();

    while(1);
}

void UART2_Init(void)
{
    RCC->AHB2ENR |= RCC_AHB2ENR_GPIOAEN;
    RCC->APB1ENR1 |= RCC_APB1ENR1_USART2EN;

    GPIOA->MODER &= ~(3<<(2*2));
    GPIOA->MODER |=  (2<<(2*2));

    GPIOA->AFR[0] |= (7<<(4*2));

    USART2->BRR = 4000000/115200;
    USART2->CR1 |= USART_CR1_TE;
    USART2->CR1 |= USART_CR1_UE;
}

void UART_SendString(char *str)
{
    while(*str)
    {
        while(!(USART2->ISR & USART_ISR_TXE));
        USART2->TDR = *str++;
    }
}

void WorkerTask(void *pvParameters)
{
    int taskNum = *(int *)pvParameters;
    char msg[50];

    while(1)
    {

    	  // Limit number of workers
    	        xSemaphoreTake(countingSem, portMAX_DELAY);

    	        // Protect UART
    	        xSemaphoreTake(uartMutex, portMAX_DELAY);
    	        sprintf(msg, "Task %d entered critical section\r\n", taskNum);
    	        UART_SendString(msg);
    	        xSemaphoreGive(uartMutex);

    	        vTaskDelay(pdMS_TO_TICKS(3000));   // Simulated work

    	        xSemaphoreTake(uartMutex, portMAX_DELAY);
    	        sprintf(msg, "Task %d leaving critical section\r\n", taskNum);
    	        UART_SendString(msg);
    	        xSemaphoreGive(uartMutex);

    	        xSemaphoreGive(countingSem);

    	        vTaskDelay(pdMS_TO_TICKS(1000));
    }
}

