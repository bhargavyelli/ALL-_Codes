#include <stdint.h>
#include "FreeRTOS.h"
#include "task.h"
#include "stm32l476xx.h"

void I2CTask(void *pvParameters);
void I2C1_Master_Transmit(uint8_t slaveAddr, uint8_t *data, uint8_t size);
void I2C1_Master_Receive(uint8_t slaveAddr, uint8_t *data, uint8_t size);

uint8_t txData[2] = {0x00, 0x55};
uint8_t rxData[2];


int main(void)
{
    I2C1_Init();

    xTaskCreate(I2CTask, "I2C Task", 256, NULL, 1, NULL);

    vTaskStartScheduler();

    while(1);
}


void I2CTask(void *pvParameters)
{
    while(1)
    {
        I2C1_Master_Transmit(0x50, txData, 2);   // Example slave addr 0x50
        vTaskDelay(pdMS_TO_TICKS(100));

        I2C1_Master_Receive(0x50, rxData, 2);

        vTaskDelay(pdMS_TO_TICKS(1000));
    }
}


void I2C1_Init(void)
{
    /* Enable clocks */
    RCC->AHB2ENR |= RCC_AHB2ENR_GPIOBEN;
    RCC->APB1ENR1 |= RCC_APB1ENR1_I2C1EN;

    /* PB6=SCL, PB7=SDA */
    GPIOB->MODER &= ~((3<<(2*6)) | (3<<(2*7)));
    GPIOB->MODER |=  ((2<<(2*6)) | (2<<(2*7)));   // Alternate function

    GPIOB->OTYPER |= (1<<6) | (1<<7);            // Open-drain
    GPIOB->OSPEEDR |= (3<<(2*6)) | (3<<(2*7));   // High speed

    GPIOB->PUPDR &= ~((3<<(2*6)) | (3<<(2*7)));
    GPIOB->PUPDR |=  ((1<<(2*6)) | (1<<(2*7)));   // Pull-up

    GPIOB->AFR[0] &= ~((0xF<<(4*6)) | (0xF<<(4*7)));
    GPIOB->AFR[0] |=  ((4<<(4*6)) | (4<<(4*7)));  // AF4 (I2C1)

    /* Disable I2C before config */
    I2C1->CR1 &= ~I2C_CR1_PE;

    /* Timing register (100kHz @ 80MHz clock example) */
    I2C1->TIMINGR = 0x10909CEC;   // Standard mode 100kHz

    /* Enable I2C */
    I2C1->CR1 |= I2C_CR1_PE;
}

void I2C1_Master_Transmit(uint8_t slaveAddr, uint8_t *data, uint8_t size)
{
    /* Set slave address & number of bytes */
    I2C1->CR2 = 0;
    I2C1->CR2 |= (slaveAddr << 1);          // 7-bit address
    I2C1->CR2 |= (size << I2C_CR2_NBYTES_Pos);
    I2C1->CR2 |= I2C_CR2_START;             // Generate START

    while(size--)
    {
        while(!(I2C1->ISR & I2C_ISR_TXIS)); // Wait TX ready
        I2C1->TXDR = *data++;
    }

    while(!(I2C1->ISR & I2C_ISR_TC));       // Wait transfer complete
    I2C1->CR2 |= I2C_CR2_STOP;              // Generate STOP
}

void I2C1_Master_Receive(uint8_t slaveAddr, uint8_t *data, uint8_t size)
{
    I2C1->CR2 = 0;
    I2C1->CR2 |= (slaveAddr << 1);
    I2C1->CR2 |= (size << I2C_CR2_NBYTES_Pos);
    I2C1->CR2 |= I2C_CR2_RD_WRN;   // Read mode
    I2C1->CR2 |= I2C_CR2_START;

    while(size--)
    {
        while(!(I2C1->ISR & I2C_ISR_RXNE)); // Wait data received
        *data++ = I2C1->RXDR;
    }

    while(!(I2C1->ISR & I2C_ISR_TC));
    I2C1->CR2 |= I2C_CR2_STOP;
}

