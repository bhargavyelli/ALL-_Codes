#include <stdint.h>
#include "stm32l4xx.h"


/* Base Addresses */
#define PERIPH_BASE        0x40000000UL
#define AHB2PERIPH_BASE    (PERIPH_BASE + 0x08000000UL)
#define APB1PERIPH_BASE    (PERIPH_BASE + 0x00000000UL)

/* RCC */
#define RCC_BASE           (AHB2PERIPH_BASE + 0x1000)
#define RCC_AHB2ENR        (*(volatile uint32_t*)(RCC_BASE + 0x4C))
#define RCC_APB1ENR1       (*(volatile uint32_t*)(RCC_BASE + 0x58))

/* GPIOA */
#define GPIOA_BASE         (AHB2PERIPH_BASE + 0x0000)
#define GPIOA_MODER        (*(volatile uint32_t*)(GPIOA_BASE + 0x00))
#define GPIOA_AFRL         (*(volatile uint32_t*)(GPIOA_BASE + 0x20))

/* USART2 */
#define USART2_BASE        (APB1PERIPH_BASE + 0x4400)
#define USART2_CR1         (*(volatile uint32_t*)(USART2_BASE + 0x00))
#define USART2_BRR         (*(volatile uint32_t*)(USART2_BASE + 0x0C))
#define USART2_ISR         (*(volatile uint32_t*)(USART2_BASE + 0x1C))
#define USART2_TDR         (*(volatile uint32_t*)(USART2_BASE + 0x28))
#define USART2_RDR         (*(volatile uint32_t*)(USART2_BASE + 0x24))

/* Function Prototypes */
void UART2_Init(void);
void UART2_WriteChar(char ch);
void UART2_WriteString(char *str);

int main(void)
{
    UART2_Init();

    while(1)
    {
        UART2_WriteString("Hello from STM32L476RG\r\n");

        for(volatile int i=0; i<500000; i++); // simple delay
    }
}

void UART2_Init(void)
{
    /* enable GPIOA clock */
    RCC_AHB2ENR |= (1 << 0);

    /* enable USART2 clock */
    RCC_APB1ENR1 |= (1 << 17);

    /* Set PA2, PA3 to Alternate Function mode*/
    GPIOA_MODER &= ~(0xF << (2 * 2));   // Clear PA2 & PA3
    GPIOA_MODER |=  (0xA << (2 * 2));   // AF mode

    /* Set AF7 for PA2, PA3 */
    GPIOA_AFRL &= ~(0xFF << (4 * 2));
    GPIOA_AFRL |=  (0x77 << (4 * 2));   // AF7

    /* 5. Set Baudrate = 115200
       Assuming 16 MHz clock
       BRR = 16000000 / 115200 â‰ˆ 139 */
    USART2_BRR = 139;

    /* 6. Enable TX, RX */
    USART2_CR1 |= (1 << 3);   // TE
    USART2_CR1 |= (1 << 2);   // RE

    /* 7. Enable USART */
    USART2_CR1 |= (1 << 0);   // UE
}

void UART2_WriteChar(char ch)
{
    while(!(USART2_ISR & (1 << 7)));  // Wait until TXE
    USART2_TDR = ch;
}

void UART2_WriteString(char *str)
{
    while(*str)
    {
        UART2_WriteChar(*str++);
    }
}
