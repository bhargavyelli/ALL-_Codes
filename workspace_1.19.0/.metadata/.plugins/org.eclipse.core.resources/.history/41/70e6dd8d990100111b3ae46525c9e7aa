#include "gpio_driver.h"
#include "stm32l4xx.h"

uint8_t mode = 0;
uint8_t ledState = 0;
uint32_t lastToggle = 0;
volatile uint32_t msTicks = 0;

/* ---------- Function Prototypes ---------- */
void led_task(void);
void check_button(void);
void SysTick_Handler(void);
/* ---------- MAIN ---------- */
int main()
{
	SystemCoreClockUpdate();
	SysTick_Config(SystemCoreClock / 1000);

    GPIOA_CLK_EN();
    GPIOC_CLK_EN();

    // LED PA5
    GPIO_Init(GPIOA, 5, GPIO_MODE_OUTPUT,
              GPIO_OTYPE_PP, GPIO_SPEED_LOW, GPIO_NO_PUPD);

    // Button PC13
    GPIO_Init(GPIOC, 13, GPIO_MODE_INPUT,
              GPIO_OTYPE_PP, GPIO_SPEED_LOW, GPIO_NO_PUPD);

    GPIO_WritePin(GPIOA, 5, 0);


    while(1)
    {
        check_button();
        led_task();
    }
}

/* ---------- LED TASK (NON-BLOCKING) ---------- */
void led_task(void)
{
    uint32_t interval;

    if(mode == 0) interval = 500;
    else if(mode == 1) interval = 400;
    else interval = 200;

    if(msTicks - lastToggle >= interval)
    {
        lastToggle = msTicks;
        ledState ^= 1;
        GPIO_WritePin(GPIOA, 5, ledState);
    }
//    ledState ^= 1;
//    GPIO_WritePin(GPIOA, 5, ledState);
//    for(int i=0;i<interval;i++);

}

/* ---------- BUTTON CHECK ---------- */
void check_button(void)
{
    static uint8_t lastState = 1;
    uint8_t currentState = GPIO_ReadPin(GPIOC, 13);

    if(lastState == 1 && currentState == 0)
    {
        mode = (mode + 1) % 3;
    }
    lastState = currentState;
}
void SysTick_Handler(void)
{
    msTicks++;
}


